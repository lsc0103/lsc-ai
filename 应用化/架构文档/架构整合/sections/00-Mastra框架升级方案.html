<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>00 - Mastra 框架升级方案</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
<div class="section-page">
    <div class="section-header">
        <h2>00 - Mastra 框架升级方案</h2>
        <div class="meta">文档版本：2.0 | 更新日期：2026-02-10 | 作者：lsc0103</div>
    </div>

    <div class="tip-box warning">
        <h4>架构重大升级说明</h4>
        <p>基于 PoC 验证结果，LSC-AI 平台从<strong>自研 @lsc-ai/core 框架</strong>升级为<strong>开源 Mastra 框架 + LSC 特色工具</strong>的混合架构。该升级在保留现有特色能力的同时，显著提升系统成熟度和稳定性。</p>
    </div>

    <h3>一、升级决策背景</h3>

    <h4>1.1 原架构评估</h4>
    <table>
        <thead>
            <tr><th>评估维度</th><th>@lsc-ai/core (自研)</th><th>评分</th></tr>
        </thead>
        <tbody>
            <tr><td>功能完整性</td><td>✅ Agent、Tools、MCP、Memory 全具备</td><td>4/5</td></tr>
            <tr><td>功能成熟度</td><td>⚠️ 基础功能可用，但缺乏深度打磨</td><td>2/5</td></tr>
            <tr><td>稳定性</td><td>⚠️ 未经大规模验证</td><td>2/5</td></tr>
            <tr><td>维护成本</td><td>❌ 需持续投入人力维护</td><td>2/5</td></tr>
            <tr><td>社区生态</td><td>❌ 无社区支持</td><td>1/5</td></tr>
            <tr><td>特色能力</td><td>✅ Office工具、MCP、项目检测</td><td>5/5</td></tr>
        </tbody>
    </table>

    <h4>1.2 开源框架对比</h4>
    <table>
        <thead>
            <tr><th>框架</th><th>成熟度</th><th>TypeScript 原生</th><th>MCP 支持</th><th>企业采用</th><th>综合评分</th></tr>
        </thead>
        <tbody>
            <tr><td>LangGraph (Python 移植)</td><td>4.7/5</td><td>❌ Python 转 JS</td><td>✅</td><td>Uber, Netflix</td><td>4.2/5</td></tr>
            <tr><td>CrewAI (Python 移植)</td><td>4.2/5</td><td>❌ Python 转 JS</td><td>❌</td><td>中小型</td><td>3.5/5</td></tr>
            <tr><td><strong>Mastra</strong></td><td><strong>4.5/5</strong></td><td><strong>✅ 原生 TS</strong></td><td><strong>✅ 原生</strong></td><td><strong>PayPal, Adobe, Docker</strong></td><td><strong>4.8/5</strong></td></tr>
            <tr><td>Vercel AI SDK</td><td>4.0/5</td><td>✅</td><td>❌</td><td>Vercel 生态</td><td>3.8/5</td></tr>
        </tbody>
    </table>

    <div class="tip-box success">
        <h5>为什么选择 Mastra？</h5>
        <ul>
            <li><strong>TypeScript 原生</strong>：与 LSC-AI 技术栈完美契合，避免 Python 移植框架的兼容性问题</li>
            <li><strong>全栈能力</strong>：Agent + Workflow + Memory + RAG + Observability 一体化</li>
            <li><strong>MCP 原生支持</strong>：保留 LSC-AI 的 MCP 扩展能力</li>
            <li><strong>企业级成熟度</strong>：$13M 融资，PayPal/Adobe/Docker 生产环境验证</li>
            <li><strong>活跃维护</strong>：Gatsby 团队开发，持续迭代更新</li>
        </ul>
    </div>

    <h3>二、PoC 验证结果</h3>

    <h4>2.1 验证项目</h4>
    <p>在 <code>D:\u3d-projects\lscmade7\lsc-ai-platform\poc-mastra</code> 完成全面验证，测试结果：</p>

    <table>
        <thead>
            <tr><th>验证项</th><th>测试内容</th><th>结果</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Step 1</strong></td>
                <td>基础 Agent + DeepSeek 集成</td>
                <td>✅ 通过<br/><small>- 中文对话正常<br/>- @ai-sdk/deepseek 集成成功</small></td>
            </tr>
            <tr>
                <td><strong>Step 2</strong></td>
                <td>工具注入验证</td>
                <td>✅ 通过<br/><small>- Zod Schema 定义工具<br/>- 文件读写工具正常</small></td>
            </tr>
            <tr>
                <td><strong>Step 3</strong></td>
                <td>Workbench Schema 输出</td>
                <td>✅ 通过<br/><small>- 代码展示 Schema<br/>- 数据表格 Schema<br/>- 多标签页 Schema</small></td>
            </tr>
            <tr>
                <td><strong>Step 4</strong></td>
                <td>Memory 持久化</td>
                <td>✅ 通过<br/><small>- LibSQL 存储正常<br/>- Thread 记忆隔离<br/>- 跨调用信息回忆</small></td>
            </tr>
            <tr>
                <td><strong>Step 5</strong></td>
                <td>NestJS Gateway 集成</td>
                <td>✅ 通过<br/><small>- 服务模式集成<br/>- 流式响应<br/>- WebSocket 事件</small></td>
            </tr>
        </tbody>
    </table>

    <div class="tip-box success">
        <strong>PoC 结论：</strong>Mastra 框架完全满足 LSC-AI 架构设计需求，在成熟度和稳定性上超越自研框架。
    </div>

    <h3>三、新架构设计</h3>

    <h4>3.1 核心技术栈升级</h4>
    <div class="grid-2">
        <div style="background: #fff7e6; padding: 16px; border-radius: 8px;">
            <h5 style="color: #d46b08; margin-top: 0;">旧架构 (Before)</h5>
            <pre style="background: white; padding: 12px; border-radius: 4px; font-size: 13px;">
<strong>AI 内核层</strong>
├── @lsc-ai/core (自研)
│   ├── Agent 系统
│   ├── 45+ 工具
│   ├── MCP 协议
│   ├── Memory 管理
│   └── Skill 系统
└── DeepSeek API</pre>
        </div>
        <div style="background: #f6ffed; padding: 16px; border-radius: 8px;">
            <h5 style="color: #389e0d; margin-top: 0;">新架构 (After)</h5>
            <pre style="background: white; padding: 12px; border-radius: 4px; font-size: 13px;">
<strong>AI 内核层 (混合架构)</strong>
├── <strong>Mastra Framework</strong> (开源)
│   ├── Agent 核心 (@mastra/core)
│   ├── Memory 持久化 (@mastra/memory)
│   ├── MCP 协议 (原生支持)
│   └── Workflow 编排
├── <strong>LSC 特色工具</strong> (保留)
│   ├── Office 办公自动化 (Word/Excel/PPT/PDF)
│   ├── 项目检测工具
│   ├── 上下文压缩
│   └── 业务工具集成
└── DeepSeek API (@ai-sdk/deepseek)</pre>
        </div>
    </div>

    <h4>3.2 Agent 体系架构升级</h4>
    <div class="tip-box info">
        <h5>三种 Agent 统一基于 Mastra + LSC 工具</h5>
        <div class="grid-3">
            <div style="background: #e6f7ff; padding: 16px; border-radius: 8px; border-left: 4px solid #1890ff;">
                <strong style="color: #1890ff;">🌐 Platform Agent</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>Mastra Agent 核心</li>
                    <li>Memory 持久化 (LibSQL/PostgreSQL)</li>
                    <li>LSC Office 工具</li>
                    <li>服务器文件操作</li>
                    <li>RPA/定时任务执行</li>
                </ul>
            </div>
            <div style="background: #f6ffed; padding: 16px; border-radius: 8px; border-left: 4px solid #52c41a;">
                <strong style="color: #52c41a;">💻 Client Agent</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>Mastra Agent 核心</li>
                    <li>本地 Memory 存储</li>
                    <li>LSC Office 工具 (完整)</li>
                    <li>本地文件系统</li>
                    <li>开发环境检测</li>
                </ul>
            </div>
            <div style="background: #fff0f6; padding: 16px; border-radius: 8px; border-left: 4px solid #eb2f96;">
                <strong style="color: #eb2f96;">🖥️ Sentinel Agent</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>Mastra Agent 核心</li>
                    <li>服务器状态监控</li>
                    <li>系统运维工具</li>
                    <li>日志分析</li>
                    <li>自动化运维决策</li>
                </ul>
            </div>
        </div>
    </div>

    <h4>3.3 依赖包升级</h4>
    <table>
        <thead>
            <tr><th>包名</th><th>版本</th><th>用途</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>@mastra/core</strong></td><td>^1.0.4</td><td>Agent 核心框架</td></tr>
            <tr><td><strong>@mastra/memory</strong></td><td>^1.0.0</td><td>Memory 持久化管理</td></tr>
            <tr><td><strong>@mastra/libsql</strong></td><td>^1.0.0</td><td>LibSQL 存储适配器</td></tr>
            <tr><td><strong>@ai-sdk/deepseek</strong></td><td>^2.0.11</td><td>DeepSeek 模型集成</td></tr>
            <tr><td><strong>zod</strong></td><td>^3.25.76</td><td>Schema 验证</td></tr>
            <tr><td style="color: #8c8c8c;"><del>@lsc-ai/core</del></td><td style="color: #8c8c8c;">-</td><td style="color: #8c8c8c;">移除（保留工具层）</td></tr>
        </tbody>
    </table>

    <h3>四、迁移计划</h3>

    <h4>4.1 迁移策略</h4>
    <div class="tip-box warning">
        <strong>渐进式迁移 (Progressive Migration)</strong>
        <p>采用渐进式迁移策略，分阶段将功能从 @lsc-ai/core 迁移到 Mastra，降低风险：</p>
    </div>

    <table>
        <thead>
            <tr><th>阶段</th><th>迁移内容</th><th>工期</th><th>风险</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Phase 1</strong><br/>基础框架</td>
                <td>
                    • 安装 Mastra 依赖<br/>
                    • 重构 AgentService<br/>
                    • 集成 DeepSeek
                </td>
                <td>2 天</td>
                <td>低</td>
            </tr>
            <tr>
                <td><strong>Phase 2</strong><br/>工具迁移</td>
                <td>
                    • 提取 LSC Office 工具<br/>
                    • 转换为 Mastra Tool 格式<br/>
                    • 验证工具调用
                </td>
                <td>3 天</td>
                <td>中</td>
            </tr>
            <tr>
                <td><strong>Phase 3</strong><br/>Memory 升级</td>
                <td>
                    • 配置 LibSQL 存储<br/>
                    • 迁移对话历史<br/>
                    • Thread 管理优化
                </td>
                <td>2 天</td>
                <td>低</td>
            </tr>
            <tr>
                <td><strong>Phase 4</strong><br/>Agent 替换</td>
                <td>
                    • Platform Agent 升级<br/>
                    • Client Agent 升级<br/>
                    • Sentinel Agent 升级
                </td>
                <td>4 天</td>
                <td>中</td>
            </tr>
            <tr>
                <td><strong>Phase 5</strong><br/>测试验证</td>
                <td>
                    • 功能回归测试<br/>
                    • 性能压力测试<br/>
                    • 生产环境验证
                </td>
                <td>3 天</td>
                <td>低</td>
            </tr>
        </tbody>
    </table>

    <h4>4.2 技术风险控制</h4>
    <table>
        <thead>
            <tr><th>风险点</th><th>缓解措施</th></tr>
        </thead>
        <tbody>
            <tr>
                <td>工具 API 兼容性</td>
                <td>保留 @lsc-ai/core 工具适配层，逐步迁移</td>
            </tr>
            <tr>
                <td>Memory 数据丢失</td>
                <td>先在测试环境验证，做好数据备份和回滚方案</td>
            </tr>
            <tr>
                <td>Agent 行为差异</td>
                <td>A/B 测试对比，确保 Prompt 工程优化</td>
            </tr>
            <tr>
                <td>性能下降</td>
                <td>性能基准测试，必要时做性能调优</td>
            </tr>
        </tbody>
    </table>

    <h3>五、收益预期</h3>

    <h4>5.1 技术收益</h4>
    <div class="grid-2">
        <div style="background: #f6ffed; padding: 16px; border-radius: 8px;">
            <h5 style="color: #52c41a; margin-top: 0;">✅ 成熟度提升</h5>
            <ul style="font-size: 13px;">
                <li>Agent 稳定性：2/5 → 4.5/5</li>
                <li>Memory 可靠性：2/5 → 4.5/5</li>
                <li>错误处理：基础 → 企业级</li>
                <li>可观测性：无 → 完整 Observability</li>
            </ul>
        </div>
        <div style="background: #e6f7ff; padding: 16px; border-radius: 8px;">
            <h5 style="color: #1890ff; margin-top: 0;">✅ 开发效率</h5>
            <ul style="font-size: 13px;">
                <li>减少框架维护成本 80%</li>
                <li>新功能开发加速 50%</li>
                <li>Bug 修复时间减少 60%</li>
                <li>文档和社区支持 ∞</li>
            </ul>
        </div>
    </div>

    <h4>5.2 业务收益</h4>
    <ul>
        <li><strong>系统稳定性</strong>：生产级框架保障 7x24 稳定运行</li>
        <li><strong>功能扩展性</strong>：基于 Mastra 生态快速集成新能力</li>
        <li><strong>用户体验</strong>：更流畅的对话交互，更精准的工具调用</li>
        <li><strong>团队信心</strong>：开源框架背书，降低技术债务</li>
    </ul>

    <h3>六、后续行动</h3>

    <div class="tip-box success">
        <h5>立即行动项</h5>
        <ol>
            <li>✅ PoC 验证完成 (已完成)</li>
            <li>✅ 架构文档更新 (当前文档)</li>
            <li>✅ Phase 1-4: Mastra 框架迁移全部完成 (2 天，超预期)</li>
            <li>✅ Phase 5: 深度产品验收 43/43 通过 (Phase H，PM 签字确认)</li>
            <li>✅ 10 个 P0 Bug 全部修复（Workbench 重写 + 工具参数映射 + Agent 通信链路）</li>
            <li>✅ LLM 多模型架构调研完成（7 个公司内网模型盘点 + Provider 抽象层设计）</li>
            <li>⏳ PoC-1: 切换到公司内网 DeepSeek V3（待 IT 确认网络连通性和 API Key）</li>
            <li>⏳ 多模型 Provider 实现 + 混合路由（调研方案已就绪，~116 行代码变更）</li>
        </ol>
    </div>

    <h3>七、参考资料</h3>
    <ul>
        <li><a href="https://mastra.ai" target="_blank">Mastra 官方网站</a></li>
        <li><a href="https://mastra.ai/docs" target="_blank">Mastra 文档</a></li>
        <li><a href="https://github.com/mastra-ai/mastra" target="_blank">Mastra GitHub</a></li>
        <li><a href="https://ai-sdk.dev" target="_blank">Vercel AI SDK</a></li>
        <li><a href="https://api-docs.deepseek.com" target="_blank">DeepSeek API 文档</a></li>
    </ul>
</div>
</body>
</html>
