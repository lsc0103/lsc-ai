<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06 - RPA 与定时任务</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="../assets/mermaid.min.js"></script>
</head>
<body>
<div class="section-page">
    <div class="section-header">
        <h2>06 - RPA 与定时任务</h2>
        <div class="meta">文档版本：1.0 | 更新日期：2026-01-19</div>
    </div>

    <h3>一、RPA 系统架构</h3>

    <h4>1.1 整体架构</h4>
    <div class="arch-diagram">
        <div class="arch-title">RPA 系统架构</div>

        <!-- 用户交互层 -->
        <div class="arch-layer user-layer">
            <span class="layer-title" style="color: #52c41a;">用户交互层</span>
            <div class="layer-content">
                <div class="arch-box">
                    <div class="arch-box-title">自然语言</div>
                    <div class="arch-box-desc">"帮我填日志"</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">RPA 管理界面</div>
                    <div class="arch-box-desc">流程配置</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">执行监控界面</div>
                    <div class="arch-box-desc">状态查看</div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- AI 决策层 -->
        <div class="arch-layer app-layer">
            <span class="layer-title" style="color: #1890ff;">AI 决策层</span>
            <div class="layer-content">
                <div class="arch-box primary" style="min-width: 400px;">
                    <div class="arch-box-title">LSC-AI Core (DeepSeek)</div>
                    <div class="arch-box-desc">理解用户意图 | 规划执行步骤 | 生成表单内容 | 异常决策</div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- RPA 执行层 -->
        <div class="arch-layer gateway-layer">
            <span class="layer-title" style="color: #faad14;">RPA 执行层</span>
            <div class="layer-content">
                <div class="arch-box warning">
                    <div class="arch-box-title">浏览器引擎</div>
                    <div class="arch-box-desc">Playwright</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">凭证管理</div>
                    <div class="arch-box-desc">加密存储</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">截图/OCR</div>
                    <div class="arch-box-desc">视觉识别</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">重试机制</div>
                    <div class="arch-box-desc">错误恢复</div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- 目标系统层 -->
        <div class="arch-layer external-layer">
            <span class="layer-title" style="color: #eb2f96;">目标系统</span>
            <div class="layer-content">
                <div class="arch-box">
                    <div class="arch-box-title">OA 系统</div>
                    <div class="arch-box-desc">Web UI</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">其他 Web 系统</div>
                    <div class="arch-box-desc">MES/WMS</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">第三方网站</div>
                    <div class="arch-box-desc">外部服务</div>
                </div>
            </div>
        </div>
    </div>

    <h4>1.2 RPA 引擎组件</h4>
    <div class="arch-diagram">
        <div class="arch-title">RPA 引擎组件</div>
        <div class="arch-layer" style="border-color: #1890ff;">
            <span class="layer-title" style="color: #1890ff;">BrowserPool</span>
            <div style="padding: 16px; text-align: center;">
                <ul style="display: inline-block; text-align: left;">
                    <li>浏览器实例池管理</li>
                    <li>复用浏览器上下文</li>
                    <li>自动清理空闲实例</li>
                </ul>
            </div>
        </div>
        <div class="connector">&#8595;</div>
        <div class="arch-layer" style="border-color: #52c41a;">
            <span class="layer-title" style="color: #52c41a;">RPAExecutor</span>
            <div style="padding: 16px; text-align: center;">
                <ul style="display: inline-block; text-align: left;">
                    <li>执行 RPA 指令序列</li>
                    <li>处理页面等待/超时</li>
                    <li>错误恢复</li>
                </ul>
            </div>
        </div>
        <div class="connector">&#8595;</div>
        <div class="layer-content" style="justify-content: center; gap: 16px; padding: 16px;">
            <div class="arch-box">
                <div class="arch-box-title">PageActions</div>
                <div class="arch-box-desc">click | type | navigate | wait</div>
            </div>
            <div class="arch-box">
                <div class="arch-box-title">FormFiller</div>
                <div class="arch-box-desc">fillInput | selectOpt | uploadFile | submit</div>
            </div>
            <div class="arch-box">
                <div class="arch-box-title">Screenshotter</div>
                <div class="arch-box-desc">capture | compare | ocr</div>
            </div>
        </div>
    </div>

    <h4>1.3 Playwright 技术选型</h4>
    <table>
        <thead><tr><th>特性</th><th>Playwright</th><th>优势</th></tr></thead>
        <tbody>
            <tr><td>浏览器支持</td><td>Chromium, Firefox, WebKit</td><td>跨浏览器兼容</td></tr>
            <tr><td>自动等待</td><td>内置智能等待</td><td>减少超时问题</td></tr>
            <tr><td>选择器</td><td>CSS, XPath, Text, Role</td><td>灵活定位元素</td></tr>
            <tr><td>截图能力</td><td>全页面/元素截图</td><td>便于调试和记录</td></tr>
            <tr><td>网络拦截</td><td>Request/Response 拦截</td><td>支持 Mock 数据</td></tr>
            <tr><td>多标签页</td><td>多 Context/Page 管理</td><td>支持复杂场景</td></tr>
            <tr><td>无头模式</td><td>Headless/Headed 切换</td><td>服务器部署友好</td></tr>
        </tbody>
    </table>

    <h3>二、RPA 工作流程</h3>

    <h4>2.1 执行时序图</h4>
    <div class="mermaid">
sequenceDiagram
    participant User as 用户
    participant AI as LSC-AI Core
    participant RPA as RPA 引擎
    participant Browser as Playwright
    participant Target as 目标系统

    User->>AI: "帮我填写今天的OA日志"
    AI->>AI: 理解意图，规划步骤
    AI->>RPA: 调用 browser 工具
    RPA->>Browser: 启动浏览器实例
    Browser-->>RPA: 浏览器就绪

    RPA->>Browser: navigate(OA登录页)
    Browser->>Target: 访问登录页
    Target-->>Browser: 返回页面

    RPA->>Browser: 填写用户名密码
    Browser->>Target: 提交登录
    Target-->>Browser: 登录成功

    RPA->>Browser: navigate(日志页面)
    Browser->>Target: 访问日志模块

    AI->>AI: 生成日志内容
    RPA->>Browser: 填写日志内容
    RPA->>Browser: 点击提交
    Target-->>Browser: 提交成功

    RPA->>Browser: 截图保存
    Browser-->>RPA: 返回截图
    RPA-->>AI: 执行完成
    AI-->>User: "OA日志已填写完成"
    </div>

    <h3>三、RPA 流程定义</h3>

    <h4>3.1 流程定义格式 (JSON)</h4>
    <pre><code>{
  "id": "oa-daily-log",
  "name": "OA 日志填报",
  "description": "自动登录 OA 系统并填写工作日志",
  "version": "1.0",
  "steps": [
    {
      "id": "step-1",
      "name": "打开登录页",
      "action": "navigate",
      "params": { "url": "{{OA_LOGIN_URL}}" },
      "timeout": 10000
    },
    {
      "id": "step-2",
      "name": "输入用户名",
      "action": "type",
      "params": {
        "selector": "#username",
        "text": "{{credential.username}}"
      }
    },
    {
      "id": "step-3",
      "name": "输入密码",
      "action": "type",
      "params": {
        "selector": "#password",
        "text": "{{credential.password}}"
      }
    },
    {
      "id": "step-4",
      "name": "点击登录",
      "action": "click",
      "params": { "selector": "#login-btn" }
    },
    {
      "id": "step-5",
      "name": "等待登录成功",
      "action": "waitFor",
      "params": { "selector": ".user-avatar", "timeout": 15000 },
      "onError": {
        "action": "screenshot",
        "then": "abort",
        "message": "登录失败"
      }
    },
    {
      "id": "step-6",
      "name": "填写日志内容",
      "action": "type",
      "params": {
        "selector": "#log-content",
        "text": "{{ai.generateContent}}"
      },
      "aiGenerate": {
        "prompt": "请根据今天的工作情况生成工作日志内容",
        "maxLength": 500
      }
    },
    {
      "id": "step-7",
      "name": "截图保存",
      "action": "screenshot",
      "params": { "saveTo": "logs/oa-daily-{{date}}.png" }
    }
  ],
  "variables": {
    "OA_LOGIN_URL": "http://oa.company.com/login"
  },
  "onComplete": { "notify": true, "message": "OA 日志填报完成" },
  "onError": {
    "notify": true,
    "retry": { "maxAttempts": 2, "delay": 5000 }
  }
}</code></pre>

    <h4>3.2 BrowserTool 实现 (TypeScript)</h4>
    <pre><code>// BrowserTool - 集成到 LSC-AI 内核

interface BrowserToolInput {
  action: BrowserAction;
  params: BrowserActionParams;
}

type BrowserAction =
  | 'launch'        // 启动浏览器
  | 'navigate'      // 导航到 URL
  | 'click'         // 点击元素
  | 'type'          // 输入文本
  | 'select'        // 选择下拉选项
  | 'screenshot'    // 截图
  | 'waitFor'       // 等待元素/条件
  | 'evaluate'      // 执行 JS
  | 'close';        // 关闭浏览器

// 工具定义
const browserToolDefinition = {
  name: 'browser',
  description: '浏览器自动化工具，用于 Web 页面操作',
  parameters: {
    type: 'object',
    properties: {
      action: {
        type: 'string',
        enum: ['launch', 'navigate', 'click', 'type',
               'select', 'screenshot', 'waitFor', 'evaluate', 'close'],
        description: '要执行的浏览器操作'
      },
      params: {
        type: 'object',
        description: '操作参数'
      }
    },
    required: ['action']
  }
};

// 工具实现
class BrowserTool implements Tool {
  private browser: Browser | null = null;
  private page: Page | null = null;

  async execute(input: BrowserToolInput): Promise&lt;ToolResult&gt; {
    switch (input.action) {
      case 'launch':
        this.browser = await chromium.launch({ headless: true });
        this.page = await this.browser.newPage();
        return { success: true, output: '浏览器已启动' };

      case 'navigate':
        await this.page!.goto(input.params.url);
        return { success: true, output: `已导航到 ${input.params.url}` };

      case 'click':
        await this.page!.click(input.params.selector);
        return { success: true, output: `已点击 ${input.params.selector}` };

      case 'type':
        await this.page!.fill(input.params.selector, input.params.text);
        return { success: true, output: '已输入文本' };

      case 'screenshot':
        const buffer = await this.page!.screenshot();
        return {
          success: true,
          output: '截图成功',
          image: buffer.toString('base64')
        };

      // ... 其他操作
    }
  }
}</code></pre>

    <h4>3.3 AI 智能增强能力</h4>
    <div class="tip-box info">
        <h5 style="margin-bottom: 12px;">AI 赋能 RPA</h5>
        <div class="grid-2">
            <div>
                <strong>1. 内容生成</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>根据上下文生成表单内容</li>
                    <li>根据模板生成报告</li>
                    <li>自动总结/摘要</li>
                </ul>
            </div>
            <div>
                <strong>2. 视觉理解</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>截图分析，判断页面状态</li>
                    <li>识别验证码（简单图形验证码）</li>
                    <li>检测弹窗/错误提示</li>
                </ul>
            </div>
            <div>
                <strong>3. 异常决策</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>遇到未预期页面，AI 分析处理</li>
                    <li>元素定位失败，尝试其他方式</li>
                    <li>判断是否需要人工介入</li>
                </ul>
            </div>
            <div>
                <strong>4. 流程优化</strong>
                <ul style="font-size: 13px; margin-top: 8px;">
                    <li>分析执行日志，提出优化建议</li>
                    <li>自动调整等待时间</li>
                    <li>检测流程中断点</li>
                </ul>
            </div>
        </div>
    </div>

    <h3>四、定时任务系统</h3>

    <h4>4.1 BullMQ 架构设计</h4>
    <div class="arch-diagram">
        <div class="arch-title">定时任务系统架构</div>

        <!-- 任务管理层 -->
        <div class="arch-layer user-layer">
            <span class="layer-title" style="color: #52c41a;">任务管理层</span>
            <div class="layer-content">
                <div class="arch-box">
                    <div class="arch-box-title">任务配置</div>
                    <div class="arch-box-desc">CRUD</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">任务列表</div>
                    <div class="arch-box-desc">查询</div>
                </div>
                <div class="arch-box">
                    <div class="arch-box-title">执行历史</div>
                    <div class="arch-box-desc">日志</div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- BullMQ 任务队列 -->
        <div class="arch-layer app-layer">
            <span class="layer-title" style="color: #1890ff;">BullMQ 任务队列</span>
            <div class="layer-content">
                <div class="arch-box primary" style="min-width: 500px;">
                    <div class="arch-box-title">Redis</div>
                    <div class="arch-box-desc">
                        scheduled:tasks (有序集合) | active:tasks | completed:tasks | failed:tasks
                    </div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- Worker 执行器 -->
        <div class="arch-layer gateway-layer">
            <span class="layer-title" style="color: #faad14;">Worker 执行器</span>
            <div class="layer-content">
                <div class="arch-box warning">
                    <div class="arch-box-title">ChatWorker</div>
                    <div class="arch-box-desc">AI 对话任务</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">RPAWorker</div>
                    <div class="arch-box-desc">RPA 执行</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">ScriptWorker</div>
                    <div class="arch-box-desc">脚本执行</div>
                </div>
                <div class="arch-box warning">
                    <div class="arch-box-title">APIWorker</div>
                    <div class="arch-box-desc">API 调用</div>
                </div>
            </div>
        </div>

        <div class="connector">&#8595;</div>

        <!-- 结果处理 -->
        <div class="arch-layer data-layer">
            <span class="layer-title" style="color: #722ed1;">结果处理</span>
            <div style="padding: 16px; text-align: center;">
                <span style="margin: 0 12px;">更新任务状态</span>|
                <span style="margin: 0 12px;">记录执行日志</span>|
                <span style="margin: 0 12px;">发送通知</span>|
                <span style="margin: 0 12px;">生成产出物</span>
            </div>
        </div>
    </div>

    <h4>4.2 任务类型</h4>
    <table>
        <thead><tr><th>任务类型</th><th>描述</th><th>示例</th></tr></thead>
        <tbody>
            <tr><td><strong>chat</strong></td><td>AI 对话任务</td><td>生成工作报告、数据分析</td></tr>
            <tr><td><strong>rpa</strong></td><td>RPA 自动化</td><td>OA 日志填报、网页操作</td></tr>
            <tr><td><strong>script</strong></td><td>脚本执行</td><td>数据同步、文件处理</td></tr>
            <tr><td><strong>api</strong></td><td>API 调用</td><td>系统健康检查、数据拉取</td></tr>
        </tbody>
    </table>

    <h4>4.3 Cron 表达式说明</h4>
    <div class="tip-box">
        <h5 style="margin-bottom: 12px;">Cron 表达式格式</h5>
        <pre style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 16px;"><code>┌───────────── 秒 (0 - 59) [可选]
│ ┌─────────── 分钟 (0 - 59)
│ │ ┌───────── 小时 (0 - 23)
│ │ │ ┌─────── 日 (1 - 31)
│ │ │ │ ┌───── 月 (1 - 12)
│ │ │ │ │ ┌─── 星期 (0 - 6, 0=周日)
│ │ │ │ │ │
* * * * * *</code></pre>
        <table>
            <thead><tr><th>表达式</th><th>说明</th></tr></thead>
            <tbody>
                <tr><td><code>0 8 * * *</code></td><td>每天早上 8:00</td></tr>
                <tr><td><code>0 8 * * 1-5</code></td><td>每个工作日早上 8:00</td></tr>
                <tr><td><code>0 */2 * * *</code></td><td>每 2 小时</td></tr>
                <tr><td><code>0 0 1 * *</code></td><td>每月 1 号 0:00</td></tr>
                <tr><td><code>0 18 * * 5</code></td><td>每周五 18:00</td></tr>
            </tbody>
        </table>
        <p style="margin-top: 12px; font-size: 13px; color: #666;">界面提供可视化 Cron 编辑器，降低使用门槛</p>
    </div>

    <h4>4.4 任务配置示例</h4>
    <pre><code>// 1. 每日工作报告
{
  "name": "每日工作报告",
  "type": "chat",
  "cronExpression": "0 8 * * *",
  "timezone": "Asia/Shanghai",
  "payload": {
    "prompt": "请根据我昨天的工作记录，生成一份工作日报。",
    "context": { "dataSource": "calendar", "dateRange": "yesterday" },
    "output": { "type": "word", "template": "daily-report", "saveTo": "reports/daily/" }
  }
}

// 2. OA 日志自动填报
{
  "name": "OA 日志自动填报",
  "type": "rpa",
  "cronExpression": "0 18 * * 1-5",
  "payload": {
    "flow": "oa-daily-log",
    "credentialId": "oa-credential-xxx",
    "params": { "contentSource": "ai-generate" }
  }
}

// 3. WMS 库存数据同步
{
  "name": "WMS 库存数据同步",
  "type": "api",
  "cronExpression": "0 */4 * * *",
  "payload": {
    "source": { "system": "wms", "endpoint": "/api/inventory/snapshot" },
    "target": { "table": "inventory_snapshots", "mode": "append" }
  }
}</code></pre>

    <h3>五、任务执行流程</h3>

    <h4>5.1 执行流程图</h4>
    <div class="mermaid">
flowchart TD
    A[定时触发/手动执行] --> B{任务类型判断}
    B -->|chat| C[ChatWorker]
    B -->|rpa| D[RPAWorker]
    B -->|script| E[ScriptWorker]
    B -->|api| F[APIWorker]

    C --> G[调用 LSC-AI Core]
    D --> H[启动 Playwright]
    E --> I[执行脚本]
    F --> J[发送 HTTP 请求]

    G --> K{执行结果}
    H --> K
    I --> K
    J --> K

    K -->|成功| L[更新状态为 success]
    K -->|失败| M{重试判断}

    M -->|重试次数未满| N[等待后重试]
    M -->|重试次数已满| O[更新状态为 failed]

    N --> B

    L --> P[记录日志]
    O --> P

    P --> Q[发送通知]
    Q --> R[生成产出物]

    style A fill:#e6f7ff,stroke:#1890ff
    style K fill:#fffbe6,stroke:#faad14
    style L fill:#f6ffed,stroke:#52c41a
    style O fill:#fff2f0,stroke:#ff4d4f
    </div>

    <h4>5.2 任务状态定义</h4>
    <pre><code>type TaskStatus =
  | 'pending'     // 等待执行
  | 'running'     // 执行中
  | 'success'     // 执行成功
  | 'failed'      // 执行失败
  | 'cancelled'   // 已取消
  | 'timeout';    // 超时

interface TaskExecution {
  id: string;
  taskId: string;
  status: TaskStatus;
  startedAt: Date;
  finishedAt?: Date;
  durationMs?: number;
  output?: string;
  error?: string;
  screenshots?: string[];  // 执行过程截图
  logs: TaskLogEntry[];
}

interface TaskLogEntry {
  timestamp: Date;
  level: 'info' | 'warn' | 'error';
  step?: string;
  message: string;
  data?: any;
}</code></pre>

    <h3>六、任务监控与告警</h3>

    <h4>6.1 监控面板</h4>
    <div class="arch-diagram">
        <div class="arch-title">任务执行监控</div>

        <!-- 统计概览 -->
        <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
            <div class="arch-box" style="text-align: center; min-width: 100px;">
                <div class="arch-box-title">今日执行</div>
                <div style="font-size: 24px; font-weight: bold; color: #1890ff;">24</div>
            </div>
            <div class="arch-box" style="text-align: center; min-width: 100px; border-color: #52c41a;">
                <div class="arch-box-title">成功</div>
                <div style="font-size: 24px; font-weight: bold; color: #52c41a;">22 (91.7%)</div>
            </div>
            <div class="arch-box" style="text-align: center; min-width: 100px; border-color: #ff4d4f;">
                <div class="arch-box-title">失败</div>
                <div style="font-size: 24px; font-weight: bold; color: #ff4d4f;">2 (8.3%)</div>
            </div>
            <div class="arch-box" style="text-align: center; min-width: 100px; border-color: #faad14;">
                <div class="arch-box-title">运行中</div>
                <div style="font-size: 24px; font-weight: bold; color: #faad14;">1</div>
            </div>
        </div>
    </div>

    <h4>6.2 执行记录表</h4>
    <table>
        <thead><tr><th>时间</th><th>任务名称</th><th>类型</th><th>状态</th><th>耗时</th><th>操作</th></tr></thead>
        <tbody>
            <tr>
                <td>08:00:05</td>
                <td>每日工作报告</td>
                <td>chat</td>
                <td style="color: #52c41a;">成功</td>
                <td>45s</td>
                <td>查看日志</td>
            </tr>
            <tr>
                <td>08:00:01</td>
                <td>WMS 数据同步</td>
                <td>api</td>
                <td style="color: #52c41a;">成功</td>
                <td>12s</td>
                <td>查看日志</td>
            </tr>
            <tr>
                <td>昨天 18:00</td>
                <td>OA 日志填报</td>
                <td>rpa</td>
                <td style="color: #ff4d4f;">失败</td>
                <td>120s</td>
                <td>查看日志</td>
            </tr>
        </tbody>
    </table>

    <h4>6.3 告警通知</h4>
    <div class="tip-box warning">
        <h5 style="margin-bottom: 12px;">告警配置</h5>
        <ul>
            <li><strong>任务失败告警</strong> - 任务执行失败时发送通知</li>
            <li><strong>超时告警</strong> - 任务执行超过预设时间</li>
            <li><strong>连续失败告警</strong> - 同一任务连续失败 N 次</li>
            <li><strong>资源告警</strong> - 浏览器实例数/队列堆积超过阈值</li>
        </ul>
        <p style="margin-top: 12px; font-size: 13px;">支持通知渠道: 企业微信 | 钉钉 | 邮件 | WebSocket 推送</p>
    </div>

    <h3>七、错误处理与重试策略</h3>

    <h4>7.1 错误类型</h4>
    <table>
        <thead><tr><th>错误类型</th><th>描述</th><th>处理策略</th></tr></thead>
        <tbody>
            <tr><td><strong>网络错误</strong></td><td>连接超时、DNS 解析失败</td><td>自动重试，指数退避</td></tr>
            <tr><td><strong>元素未找到</strong></td><td>选择器无法定位元素</td><td>等待后重试，AI 辅助定位</td></tr>
            <tr><td><strong>登录失败</strong></td><td>凭证错误、验证码</td><td>截图通知，暂停任务</td></tr>
            <tr><td><strong>页面变更</strong></td><td>目标系统 UI 改版</td><td>告警，人工介入更新流程</td></tr>
            <tr><td><strong>业务错误</strong></td><td>表单校验失败</td><td>AI 分析错误，调整输入</td></tr>
        </tbody>
    </table>

    <h4>7.2 重试策略配置</h4>
    <pre><code>interface RetryConfig {
  maxAttempts: number;      // 最大重试次数
  delay: number;            // 初始延迟 (ms)
  backoff: 'fixed' | 'exponential';  // 退避策略
  maxDelay?: number;        // 最大延迟 (ms)
}

// 默认配置
const defaultRetryConfig: RetryConfig = {
  maxAttempts: 3,
  delay: 5000,              // 5 秒
  backoff: 'exponential',   // 指数退避: 5s, 10s, 20s
  maxDelay: 60000           // 最大 60 秒
};

// 重试执行逻辑
async function executeWithRetry(task: Task, config: RetryConfig) {
  let attempt = 0;
  let lastError: Error;

  while (attempt < config.maxAttempts) {
    try {
      return await executeTask(task);
    } catch (error) {
      lastError = error;
      attempt++;

      if (attempt < config.maxAttempts) {
        const delay = config.backoff === 'exponential'
          ? Math.min(config.delay * Math.pow(2, attempt - 1), config.maxDelay)
          : config.delay;

        await sleep(delay);
        log.warn(`任务重试 ${attempt}/${config.maxAttempts}`, { taskId: task.id });
      }
    }
  }

  throw lastError;
}</code></pre>

    <h4>7.3 安全与稳定性注意事项</h4>
    <div class="grid-2">
        <div class="tip-box warning">
            <h5>安全性</h5>
            <ul>
                <li>凭证必须加密存储 (AES-256)</li>
                <li>RPA 流程执行需要权限验证</li>
                <li>敏感操作需要审批/确认</li>
                <li>执行日志脱敏处理</li>
            </ul>
        </div>
        <div class="tip-box info">
            <h5>稳定性</h5>
            <ul>
                <li>页面结构变化 - 定期检测 + 告警</li>
                <li>网络不稳定 - 重试机制</li>
                <li>目标系统维护 - 任务暂停机制</li>
                <li>资源限制 - 浏览器实例池 + 并发控制</li>
            </ul>
        </div>
    </div>

    <h3>八、实现计划</h3>

    <h4>8.1 内核层</h4>
    <table>
        <thead><tr><th>模块</th><th>内容</th><th>优先级</th><th>周期</th></tr></thead>
        <tbody>
            <tr><td>BrowserTool</td><td>Playwright 封装，浏览器操作</td><td>P0</td><td>2 周</td></tr>
            <tr><td>ScheduleTool</td><td>BullMQ 封装，定时任务注册</td><td>P0</td><td>1 周</td></tr>
        </tbody>
    </table>

    <h4>8.2 服务层</h4>
    <table>
        <thead><tr><th>模块</th><th>内容</th><th>优先级</th><th>周期</th></tr></thead>
        <tbody>
            <tr><td>TaskScheduler</td><td>定时任务调度服务</td><td>P0</td><td>1 周</td></tr>
            <tr><td>RPAEngine</td><td>RPA 执行引擎</td><td>P0</td><td>2 周</td></tr>
            <tr><td>CredentialService</td><td>凭证管理服务</td><td>P0</td><td>1 周</td></tr>
        </tbody>
    </table>

    <h4>8.3 前端层</h4>
    <table>
        <thead><tr><th>模块</th><th>内容</th><th>优先级</th><th>周期</th></tr></thead>
        <tbody>
            <tr><td>定时任务管理</td><td>任务 CRUD、Cron 编辑器</td><td>P1</td><td>1 周</td></tr>
            <tr><td>RPA 流程管理</td><td>流程定义、测试</td><td>P1</td><td>2 周</td></tr>
            <tr><td>执行监控</td><td>状态、日志、截图</td><td>P1</td><td>1 周</td></tr>
        </tbody>
    </table>

</div>

<script>
    mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });
</script>
</body>
</html>
