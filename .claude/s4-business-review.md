# S4 业务深度审视报告 — "从能看到能用"

> **发起人**：刘帅成（项目总负责人）
> **执行**：执行负责人 + PM 联合审视
> **日期**：2026-02-12
> **背景**：DACKS（大连中远川崎）2026-2027 年申报领航级智能工厂，LSC-AI 必须是真正解决生产痛点的系统

---

## 一、核心结论（先说结论）

**S4 当前实现是一个"合格的 UI 骨架"，但距离"能用的企业级自动化系统"差距巨大。**

用一个比喻：我们造好了一辆车的车身和内饰（好看、能坐人、PM 验收 28/28 通过），但还没有装**发动机**（执行引擎）、**变速箱**（数据连接器）和**轮胎**（通知系统）。

| 模块 | 当前评分 | 行业基准 | 差距判定 |
|------|---------|---------|---------|
| 任务调度 | 2/10 | 8/10 | 严重 — 自写 Cron 解析，无重试/超时/队列 |
| RPA 流程 | 2/10 | 8/10 | 严重 — 线性串行 + AI chat 执行所有步骤 |
| Sentinel Agent | 1/10 | 8/10 | 严重 — 仅注册/心跳，无任何监控能力 |
| 数据连接 | 0/10 | 8/10 | 严重 — 零外部系统集成 |
| 通知系统 | 0/10 | 7/10 | 严重 — 无邮件/钉钉/企业微信 |
| 流程编排 | 2/10 | 9/10 | 严重 — JSON 手写，无可视化 |

**同样的问题也存在于 S1-S3：**

| Sprint | 评分 | 核心问题 |
|--------|------|---------|
| S1 LLM 抽象 | 3.5/10 | 70 行工厂类，无 fallback/限流/计费/热切换 |
| S2 RAG 知识库 | 6.3/10 | 端到端完整但缺版本管理/CAD 支持/大规模优化 |
| S3 用户/项目 | 4.8/10 | 权限系统有骨架无血肉，AuditLog 表从未写入 |
| Workbench | 6.5/10 | 最强差异化，但缺实时数据管道和生产看板模板 |

---

## 二、DACKS 的真实处境与 LSC-AI 的战略意义

### 2.1 领航级智能工厂意味着什么

工信部等六部门《智能工厂梯度培育要素条件（2025年版）》定义了四级梯度：

| 等级 | 名称 | AI 要求 |
|------|------|---------|
| L1 基础级 | 关键设备数字化 | 无硬性 AI 要求 |
| L2 先进级 | 设备与系统集成 | 初步 AI 应用 |
| L3 卓越级 | 数据挖掘形成知识和模型 | AI 辅助核心业务 |
| **L4 领航级** | **全球领先，未来制造模式探索** | **AI 场景覆盖率不低于 60%** |

**关键事实：2025 年 11 月首批 15 家领航级智能工厂名单中没有任何船舶制造企业。** DACKS 如果成功申报，将成为船舶行业首家。

### 2.2 DACKS 已有的基础

DACKS 并非从零开始：
- 2023 年获评工信部"智能制造示范工厂"
- 22 条自动智能生产线 + 5G 全覆盖（85% 陆上区域）
- 世界首台全幅面数码印字设备（效率提升 90%）
- 先行分段/管材智能焊接机器人
- CIMS 生产管理系统、ERP 等信息化基础

**DACKS 的短板在 AI 软件层**——大模型、智能体、知识管理、预测分析。这正是 LSC-AI 要填补的。

### 2.3 竞争对手在做什么

**HD 现代重工**（全球第一造船集团）：
- "Future of Shipyard" 三阶段：可视化(2023) → 互联可预测(2026) → 智能自主(2030)
- 与西门子/达索合作一体化设计制造平台
- 96 台协作焊接机器人，工期缩短 30%
- AI 分析历史数据自动推荐零部件方案

**三星重工**：
- S-EDP 平台：业界首个设计-生产一体化自动化平台
- AI 安全综合管制中心：AI 图像识别 + 无人机 + 智能头盔
- 获劳氏船级社 Digital Twin Ready 认证

**中船集团**：
- "海鲲大模型"——船舶行业专用大模型
- "智海图灵"——海上 AI 基座平台
- 《船舶数字孪生系统技术规范》（2025 版）

**结论：如果 LSC-AI 只是一个"AI 对话 + 基础 CRUD"的展示系统，在这个竞争格局中毫无竞争力。**

---

## 三、S4 逐项深度分析

### 3.1 任务/RPA — 当前只是"定时执行一个 Prompt"

**代码审计发现的致命问题：**

**(1) RPA 步骤全部委托给 AI Chat**

```typescript
// mastra-workflow.service.ts — shell_command 步骤的实际实现
case 'shell_command':
  execute: async ({ inputData }) => {
    const result = await mastraAgent.chat({
      message: `请执行以下命令并返回结果: ${command}`,  // ← 让 AI "聊"出命令执行
    });
  }
```

所有 6 种步骤类型（ai_chat/shell_command/web_fetch/file_operation/condition/loop）**最终都是调用 `mastraAgent.chat()`**。这意味着：
- AI 可能"理解错"或"拒绝执行"命令
- 执行结果不确定——同一个流程跑两次结果可能不同
- 对于生产级 RPA 完全不可接受

**(2) condition 和 loop 类型未实现**

```typescript
// createRpaStep() 的 switch-case
case 'condition':  // 未实现！走 default
case 'loop':       // 未实现！走 default
default:
  // 让 AI 自由发挥
  message: `执行 RPA 步骤 (${stepDef.type}): ${JSON.stringify(stepDef.config)}`
```

**(3) 自写 Cron 解析而非用成熟库**

`task-scheduler.service.ts` 用 171 行代码自行实现了 Cron 解析。项目已有 `@nestjs/schedule`（基于 `cron` 库），完全可以用成熟的 `cron-parser` 库替代，更可靠且支持更多语法。

**(4) Mastra 框架能力被严重浪费**

Mastra Workflow 已原生支持但 LSC-AI 未使用的能力：
- `.parallel()` — 并行执行多个步骤
- `.branch()` — 条件分支
- `suspend()` / `resume()` — 人工审批节点
- `.foreach()` — 循环迭代

当前只用了最简单的 `.then()` 线性串联。

### 3.2 Sentinel Agent — 名义上是"监控哨兵"，实际只是注册表

**129 行 service + 95 行 controller = 224 行代码，做了什么？**
- 注册 Agent（存 name/hostname/IP/platform/version）
- 心跳上报（更新 lastSeenAt）
- 5 分钟无心跳标记 offline
- 健康概览（统计 total/online/offline）

**没有做什么？**
- 无指标采集（CPU/内存/磁盘/网络/进程 — 全部没有）
- 无告警规则（阈值判断/趋势检测/异常识别 — 全部没有）
- 无通知机制（邮件/钉钉/短信 — 全部没有）
- 无自动响应（触发 RPA/重启服务/清理磁盘 — 全部没有）
- 无监控仪表板（前端零 UI）
- 无 Agent 客户端（没有可部署的采集程序）

**与 CLAUDE.md 中描述的差距：**
> "管（Sentinel Agent + RPA）：AI 监控运维、执行自动化流程和定时任务"

这个描述中的每个字当前都没有实现——没有监控、没有运维、没有自动化。

### 3.3 其他 Sprint 的问题

**S1 LLM 抽象（ModelFactory — 70 行）：**
- 仅支持 2 个 Provider（deepseek + openai-compatible）
- 无 fallback（主模型不可用时无降级）
- 无 token 计费（企业必须控制 AI 使用成本）
- 无运行时热切换（改模型要重启服务）

**S2 RAG 知识库：**
- 最完整的模块（端到端：上传→解析→向量化→检索→前端展示）
- 但：50MB 文件限制（船舶图纸 PDF 可达数百 MB）
- 但：无版本管理（图纸频繁变更）
- 但：不支持 CAD/DWG 格式（船舶设计核心格式）
- 但：无项目级权限隔离

**S3 用户/项目管理：**
- `AuditLog` 表已定义但代码中从未写入——国企合规基础都没满足
- `UserPermission` 表存在但权限系统未实现
- 仅有 `admin` 一个硬编码角色
- 无组织架构（部门/车间/班组）
- 无 LDAP/AD 集成

**Workbench（最强模块）：**
- AI 动态构建可视化是独特差异化
- 但：数据全来自 AI 对话，无法接入实时生产数据
- 但：无定时刷新（设备状态需秒级更新）
- 但：无预置生产看板模板

---

## 四、对标行业——真正的企业 RPA/自动化长什么样

### 4.1 触发机制

| 触发类型 | UiPath | Power Automate | LSC-AI |
|---------|--------|---------------|--------|
| Cron 定时 | 支持 | 支持 | **仅此项** |
| 事件触发 | Event Triggers | 400+ connectors | 无 |
| Webhook/API | SHA256 签名验证 | HTTP trigger | 无 |
| 邮件触发 | Outlook Activity | 原生支持 | 无 |
| 数据变化 | Orchestrator Events | 原生支持 | 无 |
| 级联触发 | Job Events | then 链 | 无 |

### 4.2 异常处理

| 能力 | 行业标准 | LSC-AI |
|------|---------|--------|
| 步骤重试 | 自动重试 N 次 + 指数退避 | 无 |
| 事务回滚 | 自动清理 + 补偿操作 | 无 |
| 人工审核 | 异常排入审核队列 | 无 |
| 超时控制 | 每步骤独立超时 | 无 |
| 死信队列 | 永久失败任务隔离 | 无 |

### 4.3 企业集成

一家船舶制造企业的典型系统格局：

```
┌───────────────────────────────────────────┐
│           LSC-AI 平台 (智能中枢)            │
│  ┌─────┐ ┌─────┐ ┌──────┐ ┌──────────┐   │
│  │ RPA │ │ AI  │ │Sentinel│ │ Workbench │   │
│  └──┬──┘ └──┬──┘ └───┬──┘ └────┬─────┘   │
└─────┼───────┼────────┼────────┼──────────┘
      │       │        │        │
 ┌────┴───┐ ┌─┴──┐ ┌──┴──┐ ┌──┴──┐ ┌─────┐
 │ERP/SAP │ │MES │ │PLM  │ │OA/HR│ │IoT  │
 │采购/财务│ │生产 │ │设计 │ │流程 │ │传感器│
 └────────┘ └────┘ └─────┘ └─────┘ └─────┘
```

**当前 LSC-AI 与外部系统的连接数：0。** 没有数据库连接器、没有 REST API 连接器、没有 MQTT 适配器、没有文件监听。一个不能接入生产数据的 AI 平台，在船厂里就是一个昂贵的聊天机器人。

---

## 五、DACKS 的十大真实 AI 应用场景（按优先级排序）

### 场景 1：自动化生产日报/周报（优先级：P0 最高）

| 维度 | 内容 |
|------|------|
| 触发 | 每日 17:00 / 每周五 17:00 |
| 数据源 | MES 产量数据 + ERP 物料数据 + 质检系统数据 |
| AI 处理 | 汇总各分段/班组产量，分析良品率趋势，对比计划完成率，识别瓶颈工序 |
| 输出物 | 结构化周报 Word/PDF → 钉钉/邮件分发给项目经理和车间主任 |
| 行业数据 | 报表生成时间缩短 70%，数据准确性提高 90% |
| **LSC-AI 缺失** | **数据库连接器 + 报告模板引擎 + 邮件/钉钉通知** |

### 场景 2：设备状态监控与预警（优先级：P0）

| 维度 | 内容 |
|------|------|
| 触发 | 实时（秒级/分钟级） |
| 数据源 | IoT 传感器（温度/振动/电流/压力）、SCADA、PLC |
| AI 处理 | 对比运行参数与正常基线，识别异常趋势，预测故障时间窗口 |
| 输出物 | 异常预警通知 + 自动创建维修工单 + 推荐维修方案 |
| 行业数据 | 设备故障响应时间从 72h 压缩至 15min，效率提升 288 倍 |
| **LSC-AI 缺失** | **Sentinel 核心逻辑 + 时序数据存储 + 规则引擎 + 通知** |

### 场景 3：质量异常追溯与通知（优先级：P1）

| 维度 | 内容 |
|------|------|
| 触发 | 质检数据出现异常时自动触发 |
| 数据源 | X 射线探伤 + 焊接参数 + 材料追溯 + 焊工资质库 |
| AI 处理 | 关联分析缺陷原因（焊工/材料批次/设备/环境），生成 8D 分析报告 |
| 输出物 | 质量异常报告 + 根因分析 + 改进建议 → 通知质量部 |

### 场景 4-10：供应商交期跟踪、安全巡检、能源分析、管理驾驶舱、建造进度报告、工艺文件审核、培训资质管理

（详见完整调研文档）

---

## 六、Sentinel Agent 的真正定位

Sentinel 不是"注册+心跳"，它应该是部署在工厂各关键节点的 **AI 监控哨兵网络**：

| Agent 角色 | 部署位置 | 监控内容 | 联动动作 |
|-----------|---------|---------|---------|
| 设备哨兵 | 关键设备旁 | 振动/温度/电流/运行状态 | 预警→工单→停机建议 |
| 质量哨兵 | 检验工位 | 焊缝质量/尺寸精度/涂层厚度 | 异常追溯→通知→拦截 |
| 安全哨兵 | 车间入口/密闭空间 | 人员行为/环境参数/火灾风险 | 实时告警→疏散指令 |
| 进度哨兵 | 各工位/船台 | 工序完成状态/物料到位 | 进度更新→延期预警 |
| 能源哨兵 | 配电房/管网 | 电力/水/气消耗 | 异常预警→节能建议 |
| 数据哨兵 | IT 机房 | 系统可用性/数据一致性 | 故障通知→自动恢复 |

**Sentinel 五层能力模型：**
```
5. 学习层 — 基于反馈数据持续优化检测模型
4. 执行层 — 触发通知/生成报告/调用 RPA/联动 Agent
3. 决策层 — 基于规则 + AI 生成处置建议和优先级
2. 分析层 — 大模型异常检测/趋势分析/根因推理
1. 感知层 — API/IoT/DB/文件等多源数据采集
```

当前只实现了感知层的"注册和存活检测"部分，约完成 5%。

---

## 七、与领航级智能工厂的差距全景

```
领航级智能工厂 AI 能力要求 vs LSC-AI 当前实现

要求维度                    需求强度   当前完成度   差距
──────────────────────────────────────────────────────
实时数据接入(IoT/MES/ERP)   ★★★★★    ☆☆☆☆☆      ~95%
AI 质量检测/缺陷分析        ★★★★★    ☆☆☆☆☆      ~95%
设备预测性维护              ★★★★★    ☆☆☆☆☆      ~95%
生产调度优化                ★★★★★    ☆☆☆☆☆      ~95%
安全监控与预警              ★★★★☆    ☆☆☆☆☆      ~95%
数字孪生/3D 可视化          ★★★★☆    ☆☆☆☆☆      ~100%
自动化报告与通知            ★★★★☆    ☆☆☆☆☆      ~90%
知识库(图纸/工艺/标准)      ★★★★☆    ★☆☆☆☆      ~70%
跨系统数据集成              ★★★★☆    ☆☆☆☆☆      ~95%
任务/RPA 自动化执行         ★★★☆☆    ★☆☆☆☆      ~80%
AI Agent 协同网络           ★★★☆☆    ★☆☆☆☆      ~75%
AI 对话与可视化构建          ★★★☆☆    ★★★★☆      ~20% ← 核心优势
```

---

## 八、战略行动建议

### 8.1 S4 增强版路线图（S4.5）

在进入 S5 之前，建议先做 **S4.5** — 将 S4 从"骨架"升级为"可用"：

**Phase 1：基础引擎（3-4 周）— 装发动机**

| # | 工作项 | 技术方案 | 价值 |
|---|--------|---------|------|
| 1 | BullMQ 替代自写 Cron | `@nestjs/bullmq` + Redis（已部署） | 可靠调度 + 重试 + 优先级 |
| 2 | Mastra Workflow 增强 | 启用 `.branch()` / `.parallel()` / `suspend()` | 条件分支 + 并行 + 人工审批 |
| 3 | 数据库连接器 | MySQL/PostgreSQL/SQL Server 只读查询 | 接入 MES/ERP 数据 |
| 4 | 通知服务 | SMTP 邮件 + 钉钉机器人 + 企业微信 | 告警/报告分发 |
| 5 | 步骤确定性执行 | Shell/HTTP/SQL 步骤直接执行，不经 AI chat | RPA 可靠性 |

**Phase 2：可视化 + 监控（3-4 周）— 装轮胎**

| # | 工作项 | 技术方案 | 价值 |
|---|--------|---------|------|
| 6 | ReactFlow 流程编辑器 | `@xyflow/react` + 拖拽节点 | 非技术用户可定义流程 |
| 7 | 执行监控看板 | WebSocket 实时推送 + ECharts 趋势图 | 可视化运行状态 |
| 8 | Sentinel 指标采集 | `systeminformation` 库 + WebSocket 上报 | 真实系统监控 |
| 9 | 告警规则引擎 | JSON 配置阈值规则 + 大模型分析 | 异常检测 + 自动响应 |
| 10 | 审计日志落地 | AuditLog 表写入 + 关键操作记录 | 国企合规基础 |

**Phase 3：业务场景落地（3-4 周）— 上路跑**

| # | 工作项 | 价值 |
|---|--------|------|
| 11 | "自动生产周报" 端到端 Demo | 向管理层展示 AI 价值 |
| 12 | 5 个预置生产看板模板 | 管理驾驶舱 |
| 13 | Workbench 数据源绑定 + 定时刷新 | 实时数据看板 |
| 14 | Sentinel → RPA 联动 | 监控闭环 |

### 8.2 整体路线图调整建议

```
当前：S1 → S2 → S3 → S4 → S5(IDP)

建议：S1 → S2 → S3 → S4 → S4.5(增强) → S5(IDP)
                                   ↑
                              当前位置，先补课再前进
```

**理由**：S5（IDP 智能文档处理）虽然有价值，但如果 S4 的核心能力（数据连接、通知、可靠执行引擎）不补齐，S5 做出来也是孤岛——处理完文档没法通知谁、没法触发后续流程、没法接入生产系统。

### 8.3 领航级智能工厂申报时间线建议

```
2026 Q1-Q2: S4.5 增强 + 基础引擎
2026 Q3-Q4: 核心场景落地（周报/设备监控/质量/供应链）+ 申报卓越级(L3)
2027 Q1-Q2: 数字孪生 + AI 质检 + 预测维护
2027 Q3-Q4: AI 场景覆盖率达 60% + 申报领航级(L4)
```

---

## 九、致刘总

您说得对——"不希望这款产品的功能都是半吊子，只是向领导展示有了 AI 元素"。

经过这次深度审视，我们必须承认：**当前 S4 确实只完成了"展示层"**。定时任务能创建能看，RPA 流程能编辑能保存，Sentinel Agent 能注册能心跳——但这些都是"看起来有"而不是"真正能用"。

韩国 HD 现代已经在用 AI 自动推荐船舶零部件方案，三星重工已经在用 AI 管控全厂安全。而我们的 RPA 还在用 AI Chat 来"猜"该怎么执行 Shell 命令。

**好消息是：**
1. 技术栈选得不错——Mastra 框架已原生支持条件分支/并行/暂停恢复，只是我们没用
2. 基础设施已就绪——BullMQ + Redis 已在 docker-compose 中，接入成本低
3. Workbench 是真正的差异化——AI 动态构建可视化界面在国内企业 AI 平台中属前沿
4. RAG 知识库相对完整——端到端链路打通，是可以向船厂交付的真实能力

**建议：暂缓 S5，先做 S4.5 把核心引擎补齐。** 一个能接入 MES 数据、自动生成周报、钉钉推送给车间主任的系统，比一个"什么都有一点但什么都不能真正用"的系统有价值得多。

---

*本报告基于三项独立研究整合：*
1. *船舶制造行业 AI 应用需求调研（含领航级智能工厂政策分析、韩中日标杆案例）*
2. *企业级 RPA/自动化最佳实践分析（含 UiPath/Power Automate/BullMQ 技术方案）*
3. *S1-S4 代码深度审计（逐文件审读，含评分和差距分析）*
