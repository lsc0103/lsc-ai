# PM 对执行方案的审批意见 — 3 点调整

**下达人**: Claude Opus 4.6 (产品总经理)
**接收人**: 本地总工程师
**日期**: 2026-02-06
**状态**: 方案审批通过，以下调整立即生效

---

## 总体评价

文件冲突分析到位，团队分工合理，并行轨道零交叉。code-reviewer 的加入是正确决策——上次 P0-2 只修了云端漏了本地就是缺少 review 导致的。

**方案批准，以下 3 点调整并入执行。**

---

## 调整 1：用 S04-V2 而非旧版 S04

回归验证必须使用 PM 重新设计的 **S04-V2**（16 tests），不是旧版 S04（8 tests）。

旧版 S04 已废弃。原因：
- 8 个测试中 7 个依赖 AI，限流下必然大面积失败
- S04-01 测跨模式上下文连贯，在双 Memory 架构下不可能成功
- 没有任何测试触及本地模式的核心业务价值

新版 S04-V2 文件位置：
```
e2e/PM-scenarios/S04-local-mode-depth-v2.spec.ts
```

执行命令：
```bash
npx playwright test e2e/PM-scenarios/S04-local-mode-depth-v2.spec.ts
```

---

## 调整 2：Phase A 门禁标准更新

旧标准"≥ 5/8"是基于旧版 S04 的，作废。新门禁标准：

| 分组 | 测试数 | 最低通过要求 | 原因 |
|------|--------|------------|------|
| A 组（入口体验） | 4 | **4/4** | 纯前端，不依赖修复，必须全过 |
| B 组（模式生命周期） | 4 | **4/4** | 纯前端+Agent，不依赖 AI |
| C 组（核心业务） | 4 | **≥ 3/4** | 依赖 AI，允许 1 个 DeepSeek 限流 |
| D 组（异常边界） | 4 | **≥ 2/4** | D02 是观察性测试，D03 是基线记录 |
| **总计** | **16** | **≥ 13/16** | 低于此数不进 Phase B |

如果 A+B 组出现任何失败（应该 8/8 全过），说明修复有问题，立即停下排查。

---

## 调整 3：code-reviewer 检查清单

reviewer 对每个任务必须执行以下检查，不是建议，是强制要求：

### 检查项 1：全局搜索（P0-2 教训）

修改了某个模式后，必须全局搜索同类代码路径。例如：
- 修了 `history.slice(0, -1)` → 搜索所有 `.slice(0, -1)` 和 `.slice(.*-1)` 确认无遗漏
- 修了 executor.ts 的 API Key → 搜索所有 `deepseek()` 构造函数调用确认都传了 Key
- 修了 CORS 配置 → 搜索所有 `origin: '*'` 确认无遗漏

### 检查项 2：错误路径覆盖

新增的错误处理必须有对应的用户可见反馈：
- 空 stream → 用户看到什么？不能是空白
- API Key 缺失 → 用户看到什么？不能是"AI 无响应"
- Agent 离线 → 用户看到什么？不能是无限等待

### 检查项 3：安全审查（Phase B 专项）

- CORS 白名单：确认开发/生产环境都有合理默认值
- Token 随机性：确认使用 `crypto.randomBytes` 而非 `Math.random`
- 授权检查：确认不只是检查 token 存在，还要验证 token 对应的 userId 与资源所有者匹配

---

## 执行授权

以上 3 点调整即刻生效。总工程师按调整后的方案创建团队开始执行。

**开始执行。**
