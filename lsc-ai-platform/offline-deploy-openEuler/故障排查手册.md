# LSC-AI 平台 - 故障排查手册

> 本手册包含所有常见错误的详细解决方案

---

## 目录

1. [部署前检查清单](#一部署前检查清单)
2. [常见部署错误](#二常见部署错误)
3. [自动回滚说明](#三自动回滚说明)
4. [完整清理流程](#四完整清理流程)
5. [调试命令大全](#五调试命令大全)
6. [部署后验证](#六部署后验证)
7. [性能问题排查](#七性能问题排查)

---

## 一、部署前检查清单

部署前执行以下检查，避免常见错误：

### 1. 系统要求检查

```bash
# 检查操作系统
cat /etc/openEuler-release
# 要求: openEuler 20.03 LTS 或更高

# 检查内存
free -h
# 要求: 至少 8GB

# 检查磁盘空间
df -h /opt
# 要求: 至少 50GB 可用空间

# 检查 CPU
lscpu | grep "CPU(s)"
# 要求: 至少 4 核
```

### 2. 端口检查

```bash
# 检查关键端口是否被占用
netstat -tlnp | grep -E ":(80|3000|5432|6379|9000|9001)\s"

# 如果有输出，说明端口被占用
# 需要停止占用端口的服务
```

常见端口占用解决：
```bash
# 端口 80 (Web)
systemctl stop httpd    # 或 nginx, apache2

# 端口 3000 (API)
lsof -ti:3000 | xargs kill -9

# 端口 5432 (PostgreSQL)
systemctl stop postgresql
```

### 3. 文件完整性检查

```bash
cd /opt/offline-deploy-openEuler

# 检查关键文件是否存在
ls -lh docker-images.tar                # 应该约 263MB
ls -lh downloads/*.rpm                  # 应该有 6 个 RPM 文件
ls -lh scripts/deploy.sh               # 部署脚本
ls -lh docker/docker-compose.yml       # Docker 配置

# 检查脚本权限
ls -l scripts/*.sh
# 应该显示 -rwxr-xr-x（可执行）
```

### 4. Root 权限检查

```bash
# 确认是 root 用户
whoami
# 应该输出: root

# 或者使用 sudo
sudo -v
# 应该无错误输出
```

---

## 二、常见部署错误

### 错误 1: Docker 安装失败

**症状**：
```
[ERROR] Docker installation failed
rpm: command not found
```

**原因**：系统缺少 RPM 包管理器或 RPM 文件损坏

**解决方案**：
```bash
# 方案 1: 检查 yum 是否可用
yum --version

# 方案 2: 检查 RPM 文件完整性
cd downloads
ls -lh *.rpm
md5sum *.rpm

# 方案 3: 手动安装 RPM
rpm -ivh containerd.io-*.rpm
rpm -ivh docker-ce-cli-*.rpm
rpm -ivh docker-ce-*.rpm
rpm -ivh docker-compose-plugin-*.rpm

# 方案 4: 检查依赖
yum check-update
yum install -y libseccomp device-mapper-libs
```

---

### 错误 2: Docker 服务启动失败

**症状**：
```
[ERROR] Docker failed to start
Job for docker.service failed
```

**原因**：Docker daemon 配置问题或权限问题

**解决方案**：
```bash
# 查看详细错误
journalctl -u docker -n 50

# 常见问题 1: SELinux 冲突
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# 常见问题 2: 防火墙冲突
systemctl stop firewalld
systemctl disable firewalld

# 常见问题 3: 配置文件错误
rm -f /etc/docker/daemon.json
systemctl restart docker

# 常见问题 4: 内核模块未加载
modprobe overlay
modprobe br_netfilter

# 重新启动 Docker
systemctl daemon-reload
systemctl start docker
systemctl status docker
```

---

### 错误 3: 镜像加载失败

**症状**：
```
[ERROR] Failed to load lscai/server image
Error processing tar file(exit status 1): unexpected EOF
```

**原因**：镜像文件损坏或磁盘空间不足

**解决方案**：
```bash
# 检查磁盘空间
df -h /var/lib/docker
# 至少需要 30GB 可用空间

# 清理 Docker 缓存
docker system prune -a -f

# 检查镜像文件完整性
ls -lh docker-images.tar
# 应该约 263MB

# 重新加载镜像
docker load -i docker-images.tar

# 验证镜像已加载
docker images | grep lscai
```

---

### 错误 4: 端口被占用

**症状**：
```
[ERROR] Port 80 already in use
Error: bind: address already in use
Ports are not available: exposing port TCP 0.0.0.0:80
```

**原因**：其他服务占用了端口

**解决方案**：
```bash
# 找出占用端口的进程
lsof -i :80
netstat -tlnp | grep :80

# 停止占用的服务
# 示例: Apache/Nginx
systemctl stop httpd
systemctl stop nginx
systemctl disable httpd
systemctl disable nginx

# 或直接杀死进程
lsof -ti:80 | xargs kill -9

# 验证端口已释放
lsof -i :80
# 应该无输出

# 重新部署
sudo bash scripts/deploy.sh
```

**所有可能冲突的端口**：
- **80**: Web 前端 → 停止 httpd/nginx
- **3000**: API 服务 → 检查其他应用
- **5432**: PostgreSQL → 停止系统 PostgreSQL
- **6379**: Redis → 停止系统 Redis
- **9000/9001**: MinIO → 检查其他对象存储服务

---

### 错误 5: 磁盘空间不足

**症状**：
```
[ERROR] Insufficient disk space: 30GB (need 50GB)
Error: no space left on device
```

**原因**：磁盘空间不足

**解决方案**：
```bash
# 检查磁盘使用情况
df -h

# 清理 Docker 缓存和未使用资源
docker system prune -a -f
docker volume prune -f
docker image prune -a -f

# 清理系统缓存
yum clean all
rm -rf /var/cache/yum/*
rm -rf /tmp/*

# 查找大文件
du -h /opt | sort -rh | head -20

# 删除旧日志
find /var/log -type f -name "*.log" -mtime +30 -delete
journalctl --vacuum-time=7d

# 检查空间是否足够
df -h
```

---

### 错误 6: 容器启动失败

**症状**：
```
[ERROR] Container lscai-server failed to start
Error response from daemon: container xxx is restarting
```

**原因**：容器配置错误或依赖服务未就绪

**解决方案**：
```bash
cd /opt/offline-deploy-openEuler/docker

# 检查容器状态
docker compose ps

# 查看失败容器的日志
docker compose logs server
docker compose logs postgres
docker compose logs redis

# 常见问题 1: 数据库未就绪
# 等待 PostgreSQL 启动
sleep 30
docker compose restart server

# 常见问题 2: 环境变量错误
# 检查配置文件
cat .env
# 确保所有必需的变量都存在

# 常见问题 3: 镜像问题
# 重新创建容器
docker compose up -d --force-recreate

# 常见问题 4: 网络问题
# 重建网络
docker network rm lscai-network
docker compose up -d
```

---

### 错误 7: PostgreSQL 连接失败

**症状**：
```
[ERROR] PostgreSQL failed to start (timeout)
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**原因**：PostgreSQL 启动超时或配置错误

**解决方案**：
```bash
cd /opt/offline-deploy-openEuler/docker

# 检查 PostgreSQL 状态
docker compose ps postgres

# 查看 PostgreSQL 日志
docker compose logs postgres

# 手动检查 PostgreSQL 是否就绪
docker compose exec postgres pg_isready -U lscai

# 常见问题 1: 启动时间过长
# 等待更长时间（2-3分钟）
sleep 120
docker compose exec postgres pg_isready -U lscai

# 常见问题 2: 密码错误
# 检查环境变量
docker compose exec postgres env | grep POSTGRES

# 常见问题 3: 数据卷损坏
# 删除数据卷并重新创建
docker compose down -v
docker volume rm lscai-postgres-data
docker compose up -d postgres

# 常见问题 4: 内存不足
# 检查内存使用
free -h
docker stats postgres
```

---

### 错误 8: 权限错误

**症状**：
```
Permission denied
cp: cannot create regular file
```

**原因**：未使用 root 权限

**解决方案**：
```bash
# 使用 sudo
sudo bash scripts/deploy.sh

# 或切换到 root 用户
sudo su -
cd /opt/offline-deploy-openEuler
bash scripts/deploy.sh
```

---

## 三、自动回滚说明

### 什么是自动回滚？

部署脚本采用 **事务性（Transactional）** 模式：
- ✅ **成功**：所有步骤完成，系统正常运行
- ❌ **失败**：自动回滚，零痕迹，系统恢复原状

### 回滚包含什么？

自动回滚会删除：
1. 所有容器（lscai-*）
2. 所有数据卷（lscai-*-data）
3. 所有加载的镜像（仅当是本次部署加载的）
4. Docker 网络（lscai-network）
5. 生成的配置文件（.env、CREDENTIALS_*.txt）
6. Docker（仅当是本次部署安装的）

### 回滚保留什么？

回滚会保留：
- ✅ 部署日志（deployment.log）
- ✅ 原始部署包文件
- ✅ Docker（如果之前已安装）

### 回滚后如何重试？

```bash
# 1. 查看错误日志
cat /opt/offline-deploy-openEuler/deployment.log

# 2. 修复问题（参考本手册）

# 3. 直接重新部署（无需手动清理）
sudo bash scripts/deploy.sh
```

---

## 四、完整清理流程

### 场景 1: 部署失败后清理

**不需要手动清理！** 脚本已自动回滚。直接修复问题后重试即可。

### 场景 2: 部署成功后想卸载

```bash
cd /opt/offline-deploy-openEuler

# 运行清理脚本
sudo bash scripts/cleanup.sh

# 按提示操作：
# - 删除数据卷？yes（会丢失所有数据）
# - 卸载 Docker？no（保留 Docker）
```

### 场景 3: 完全手动清理

如果需要完全手动清理：

```bash
cd /opt/offline-deploy-openEuler/docker

# 1. 停止并删除所有容器
docker compose down -v

# 2. 删除所有数据卷
docker volume rm lscai-postgres-data
docker volume rm lscai-redis-data
docker volume rm lscai-minio-data
docker volume rm lscai-libsql-data

# 3. 删除所有镜像（可选）
docker rmi lscai/server:latest
docker rmi lscai/web:latest
docker rmi postgres:15-alpine
docker rmi redis:7-alpine
docker rmi minio/minio:latest

# 4. 删除网络
docker network rm lscai-network

# 5. 删除配置文件
cd /opt/offline-deploy-openEuler
rm -f config/.env
rm -f docker/.env
rm -f config/CREDENTIALS_*.txt

# 6. 卸载 Docker（可选）
systemctl stop docker
systemctl disable docker
yum remove -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

---

## 五、调试命令大全

### Docker 相关

```bash
# 检查 Docker 状态
systemctl status docker
docker info
docker version

# 检查 Docker Compose
docker compose version

# 查看所有容器
docker ps -a

# 查看所有镜像
docker images

# 查看所有数据卷
docker volume ls

# 查看所有网络
docker network ls

# 清理未使用的资源
docker system prune -a -f
```

### 容器相关

```bash
cd /opt/offline-deploy-openEuler/docker

# 查看容器状态
docker compose ps

# 查看特定容器日志
docker compose logs server
docker compose logs postgres
docker compose logs web

# 实时跟踪日志
docker compose logs -f server

# 进入容器内部
docker compose exec server sh
docker compose exec postgres psql -U lscai -d lscai

# 重启特定容器
docker compose restart server

# 重新创建容器
docker compose up -d --force-recreate server

# 查看容器资源使用
docker stats
```

### 网络相关

```bash
# 检查端口占用
netstat -tlnp
lsof -i :80
lsof -i :3000

# 测试端口连通性
curl http://localhost:3000/api/health
curl -I http://localhost:80

# 检查防火墙
systemctl status firewalld
firewall-cmd --list-all

# 检查 SELinux
getenforce
```

### 系统相关

```bash
# 检查磁盘空间
df -h
du -sh /var/lib/docker

# 检查内存
free -h
vmstat 1 5

# 检查 CPU
top
htop

# 检查系统日志
journalctl -xe
journalctl -u docker -n 50

# 检查进程
ps aux | grep docker
ps aux | grep lscai
```

---

## 六、部署后验证

### 完整验证流程

```bash
# 1. 检查所有容器状态
cd /opt/offline-deploy-openEuler/docker
docker compose ps
# 应该全部显示 Up 或 healthy

# 2. 检查 API 健康
curl http://localhost:3000/api/health
# 应该返回: {"status":"ok"}

# 3. 检查 Web 前端
curl -I http://localhost:80
# 应该返回: HTTP/1.1 200 OK

# 4. 检查 PostgreSQL
docker compose exec postgres pg_isready -U lscai
# 应该返回: accepting connections

# 5. 检查 Redis
docker compose exec redis redis-cli ping
# 应该返回: PONG

# 6. 检查 MinIO
curl http://localhost:9000/minio/health/live
# 应该返回: OK

# 7. 查看所有日志
docker compose logs --tail=50
# 不应该有 ERROR 或 FATAL 日志
```

### 浏览器测试

1. 打开浏览器访问：`http://<服务器IP>`
2. 使用账号：`admin` / `Admin@123` 登录
3. 创建一个测试会话
4. 发送一条测试消息
5. 验证 AI 回复正常

---

## 七、性能问题排查

### 响应缓慢

```bash
# 检查系统资源
top
htop
docker stats

# 检查磁盘 I/O
iostat -x 1

# 检查网络
iftop
netstat -s

# 优化建议
# 1. 增加内存
# 2. 使用 SSD 硬盘
# 3. 调整 Docker 资源限制
```

### 数据库性能问题

```bash
# 进入 PostgreSQL
docker compose exec postgres psql -U lscai -d lscai

# 查看慢查询
SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;

# 查看表大小
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;

# 分析查询计划
EXPLAIN ANALYZE SELECT * FROM sessions;
```

---

## 八、联系支持

如果以上方案都无法解决问题，请联系系统管理员，并提供以下信息：

### 收集诊断信息

```bash
cd /opt/offline-deploy-openEuler

# 收集所有日志
docker compose logs > /tmp/lscai-logs.txt

# 收集部署日志
cp deployment.log /tmp/

# 收集系统信息
{
  echo "=== System Info ==="
  uname -a
  cat /etc/openEuler-release

  echo "=== Resources ==="
  free -h
  df -h

  echo "=== Docker Info ==="
  docker info
  docker compose ps

  echo "=== Network ==="
  netstat -tlnp
} > /tmp/lscai-system.txt

# 打包所有诊断文件
tar -czf /tmp/lscai-diagnostics.tar.gz /tmp/lscai-*.txt

echo "诊断信息已保存到: /tmp/lscai-diagnostics.tar.gz"
```

### 提供的信息

1. **错误描述**：详细描述问题
2. **日志文件**：`/tmp/lscai-diagnostics.tar.gz`
3. **复现步骤**：如何触发错误
4. **环境信息**：服务器配置、操作系统版本

---

## 快速参考卡

| 问题 | 快速命令 |
|------|---------|
| 查看容器状态 | `docker compose ps` |
| 查看日志 | `docker compose logs -f` |
| 重启服务 | `docker compose restart` |
| 检查端口 | `netstat -tlnp \| grep :80` |
| 清理 Docker | `docker system prune -a -f` |
| 检查磁盘 | `df -h` |
| 查看部署日志 | `cat deployment.log` |
| 完全重新部署 | `bash scripts/cleanup.sh && bash scripts/deploy.sh` |

---

**记住**：遇到问题不要慌，按照本手册一步步排查，大多数问题都能快速解决！
